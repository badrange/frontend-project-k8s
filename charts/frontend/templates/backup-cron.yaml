{{- if .Values.backup.enabled }}
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: {{ .Release.Name }}-backup
  labels:
    cronjob-type: backup
spec:
  schedule: {{ .Values.backup.schedule | replace "~" (randNumeric 1) | quote }}
  concurrencyPolicy: Forbid
  startingDeadlineSeconds: 3600
  failedJobsHistoryLimit: 1
  successfulJobsHistoryLimit: 1
  suspend: false
  jobTemplate:
    spec:
      activeDeadlineSeconds: 7200
      backoffLimit: 2
      template:
        spec:
          enableServiceLinks: false
          initContainers:
            - name: backup-linking
              image: eu.gcr.io/silta-images/rsync:latest
              command: ["/bin/bash", "-c"]
              args:
                - |
                  {{- include "frontend.backup.create-destination-path" . | nindent 18 }}
              volumeMounts:
                {{- range $index, $mount := $.Values.mounts }}
                {{- if eq $mount.enabled true }}
                - name: frontend-{{ $index }}
                  mountPath: /values_mounts/{{ $index }}
                {{- end }}
                {{- end }}
                - name: {{ .Release.Name }}-backup
                  mountPath: /backup_archive
                - mountPath: /backups
                  name: shared-data
          containers:
          - name: backup
            image: eu.gcr.io/silta-images/rsync:latest
            volumeMounts:
              {{- range $index, $mount := $.Values.mounts -}}
              {{- if eq $mount.enabled true }}
              - name: frontend-{{ $index }}
                mountPath: /values_mounts/{{ $index }}
              {{- end }}
              {{- end }}
              - name: {{ $.Release.Name }}-backup
                mountPath: /backup_archive
              - mountPath: /backups
                name: shared-data
            command: ["/bin/bash", "-c"]
            args:
              - |
                {{- include "frontend.backup.copy-mounts" . | nindent 16 }}
                
                # Delete old backups
                echo "Removing backups older than {{ .Values.backup.retention }} days"

                # Can't locate directories based on mtime due to storage backend limitations, 
                # Using folder name for time selection. 
                retention_time=$(date -d "{{ .Values.backup.retention }} days ago" +%s)
                
                set +x
                
                find /backup_archive/*[0-9][0-9][0-9][0-9]-[0-1][0-9]-[0-3][0-9]* -type d -print | while read -r d; do
                  
                  # Strict directory name matching with the patern
                  n=$(basename "$d")
                  de=$(expr "X$n" : 'X.*\([0-9]\{4,\}-[0-9]\{2\}-[0-9]\{2,\}\)')
                  test -n "$de" || continue

                  # Extract directory name based on pattern and make sure it can be parsed as date
                  dt=$(echo "$d" | sed -re "s/.*([0-9]{4}-[0-9]{2}-[0-9]{2}).*/\1/")
                  date -d "$dt" >/dev/null 2>&1 || continue

                  # Convert date to timetamp and compare with retention time
                  file_time=$(date -d "$dt" +%s)
                  test "$file_time" -lt "$retention_time" || continue

                  # If we're still in the execution block, all checks have passed and we can remove the directory.
                  echo "TODO: Remove dir: $d"
                done

                set -x
                
          {{- range $index, $service := .Values.services }}
          {{- $backupCommand := "" }}
          {{- if (hasKey $service "backup") }}
          {{- if (hasKey $service.backup "command") }}
          {{- $backupCommand = $service.backup.command }}
          {{- end }}
          {{- end }}
          {{- if $backupCommand }}
          - name: {{ $index }}
            image: {{ $service.image | quote }}
            command: ["/bin/bash", "-c"]
            args:
              - |
                {{- $backupCommand | nindent 16 }}
            env:
            {{- include "services.env" (dict "Values" $.Values "Release" $.Release "service" $service) | nindent 12 }}
            {{- range $key, $val := $service.env }}
            - name: {{ $key }}
              value: {{ $val | quote }}
            {{- end }}
            volumeMounts:
              - name: {{ $.Release.Name }}-backup
                mountPath: /backup_archive
              - mountPath: /backups
                name: shared-data
              {{ if $service.mounts }}
              {{- range $index, $mountName := $service.mounts -}}
              {{ $mount := (index $.Values.mounts $mountName) }}
              {{- if eq $mount.enabled true }}
              - name: frontend-{{ $mountName }}
                mountPath: {{ $mount.mountPath }}
              {{- end }}
              {{- end }}
              {{- end }}
          {{- end }}
          {{- end }}
          restartPolicy: Never
          volumes:
            - name: shared-data
              emptyDir:
                sizeLimit: 10M
            {{- range $index, $service := .Values.services }}
            {{- if $service.mounts -}}
            {{- range $index, $mountName := $service.mounts -}}
            {{ $mount := (index $.Values.mounts $mountName) }}
            {{- if eq $mount.enabled true }}
            - name: frontend-{{ $mountName }}
              persistentVolumeClaim:
                claimName: {{ $.Release.Name }}-{{ $mountName }}
            {{- end }}
            {{- end }}
            {{- end }}
            {{- end }}
            - name: {{ .Release.Name }}-backup
              persistentVolumeClaim:
                claimName: {{ .Release.Name }}-backup
{{- end }}
